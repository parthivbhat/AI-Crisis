<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Crisis Alert</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { padding: 20px; }
    #riskVal { font-weight: bold; font-size: 20px; }
    .high { color: red; }
    .low { color: green; }
  </style>
</head>

<body>
  <div class="container">
    <h2>AI Crisis Alert System</h2>
    <p>Record audio or upload to detect panic/screams.</p>

    <button id="recordBtn" class="btn btn-primary">ðŸŽ¤ Record 5s</button>
    <input type="file" id="fileInput" accept="audio/*" class="form-control mt-3">

    <div class="card mt-4" id="resultCard" style="display:none;">
      <div class="card-body">
        <h4>Analysis Result</h4>
        <p>Risk Score: <span id="riskVal"></span></p>
        <pre id="details"></pre>
      </div>
    </div>

    <p id="log" class="mt-3 text-muted"></p>
  </div>

<script>
let mediaRecorder;
let audioChunks = [];

document.getElementById("recordBtn").onclick = async () => {
  audioChunks = [];
  document.getElementById("log").innerText = "Requesting mic access...";
  console.log("Requesting mic...");

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    console.log("Mic granted");

    mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
    console.log("Recorder created:", mediaRecorder);

    mediaRecorder.ondataavailable = e => {
      console.log("Captured chunk:", e.data);
      audioChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
      console.log("Recording stopped. Preparing upload...");
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      await sendAudio(blob);
    };

    mediaRecorder.start();
    console.log("Recording started");
    document.getElementById("log").innerText = "Recording for 5 seconds...";

    setTimeout(() => {
      console.log("Stopping...");
      mediaRecorder.stop();
    }, 5000);

  } catch (err) {
    console.error("Mic error:", err);
    alert("Microphone access blocked. Enable it in Chrome â†’ Lock icon â†’ Microphone â†’ Allow");
  }
};

document.getElementById("fileInput").onchange = async e => {
  const file = e.target.files[0];
  if (file) await sendAudio(file);
};

async function sendAudio(file) {
  document.getElementById("log").innerText = "Analyzing audio...";
  console.log("Uploading file...");

  const fd = new FormData();
  fd.append("audio", file);

  const res = await fetch("/analyze", { method: "POST", body: fd });
  const data = await res.json();

  console.log("Server Response:", data);

  document.getElementById("resultCard").style.display = "block";
  document.getElementById("riskVal").innerText = data.risk_score;

  if (data.risk_score >= data.threshold)
    document.getElementById("riskVal").className = "high";
  else
    document.getElementById("riskVal").className = "low";

  document.getElementById("details").innerText = JSON.stringify(data.features, null, 2);
  document.getElementById("log").innerText = "Done!";
}
</script>

</body>
</html>
